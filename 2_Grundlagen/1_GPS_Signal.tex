\section{GPS Signal}
Der GNSS Empfänger der im Rahmen dieser Arbeit entwickelt werden soll verwendet das \gls{GPS} als Quelle für Navigationsdaten. In diesem Abschnitt soll ein Überblick über die Eigenschaften des Signals, sowie ein Überblick über die Demodulation Signals gegeben werden. Dabei wird sich auf die für die für diese Arbeit wichtigen Teile beschränkt: Das GPS verwendet mehrere Frequenzen und in neueren Versionen auch mehrere Modulationsverfahren \cite{specification2010gps}. Der im Rahmen dieser Arbeit entworfene Empfänger verwendet lediglich das zivil nutzbare Signal auf der L1 Frequenz mit C/A Kodierung\footnote{Beginned mit dem Jahr 2016 sollen in Zukunft 2016 auch weitere Übertragungskanäle für zivile Anwendunge zur Verfügung stehen. Siehe \cite{interface1gps}, \cite{specification2010gps} und \cite{navstar2006space}}. Für die anderen Teile des Standards sei auf die offizielle GPS Spezifikation verwiesen (\cite{specification2010gps}) verwiesen. Weiterhin gibt \cite{borre2007software} eine sehr gute Einführung zu \gls{SDR} Empfängern für \gls{GPS} und Galileo. 

Auch wenn GPS aus Sicht des Empfängers kein Netzwerkprotokoll ist, orientiert sich die folgende Beschreibung grob am OSI Modell: Zu Beginn wird die Bitübertragungsschicht (\emph{Physical Layer}) diskutiert. Im zweiten Unterabschnitt wird das verwendete Multiplex Verfahren beschrieben (\emph{\gls{MAC} Layer}). Abschließend werden die übertragenen Nutzdaten beschrieben.

\subsection{Bitübertragungsschicht}
Die von der darüberliegenden Schicht erhaltenen Daten werden auf der Bitübertragungsschicht auf einen Träger aufmoduliert und ausgesendet. 

\paragraph{Träger} 
Auf dem Satelliten befindet sich eine hoch genaue Taktquelle mit \SI{10.2299999954326}{\MHz}. Durch relativistische Effekte erscheint diese Frequenz für einen Beobachter auf der Erde wie \SI{10.23}{\MHz}. Von dieser Taktquelle sind alle weiteren Frequenzen abgeleitet. Ein Frequenzsynthesizer generiert aus dem Referenztakt durch Vervielfachung mit dem Faktor 154 den Träger für das \gls{PY} Signal für die sogenannte L1 Frequenz (\SI{1575.42}{\MHz}). Der Träger für das zivil genutzte \gls{CA} Signal wird aus dem \gls{PY} Träger durch \SI{90}{\degree} Phasenverschiebung gewonnen.

\paragraph{Modulation}
Die von der darüberliegenden Schicht erhaltenen Daten werden auf den Träger mittels \gls{BPSK} moduliert. Die Zuordnung der $1$en und $0$en zu den Phasenlagen bezieht sich dabei auf das gleichzeitig übertragene \gls{PY} Signal\footnote{Das \gls{PY} Signal ist das militärisch genutzte GPS Signal auf der L1 Frequenz. Wie jedoch später beschrieben wird, ist es zur Dekodierung des \gls{CA} Signals nicht notwendig das \gls{PY} Signal dekodieren zu können}: Die Phasenlage die der \gls{PY} Träger annimmt wenn eine $0$ übertragen wird ist als \SI{0}{\degree} definiert. Wenn das \gls{CA} Signal den Wert $1$ übertragen soll, eilt der \gls{CA} Träger dem \gls{PY} \SI{90}{\degree} vor. Bei einer $0$ eilt das CA Signal \SI{90}{\degree} nach.

Das ausgesendete Signal ergibt sich durch Addition des \gls{CA} Signals mit dem um \SI{3}{\dB} gedämpften \gls{PY} Signal. \FR{GPSConstellation} stellt die Symbolkonstellation grafisch dar. Wie man sieht, gibt es je zwei Symbole die eine $1$ bzw. eine $0$ des CA Signals signalisieren. Ein Empfänger wendet auf das empfangene Signal einen Tiefpassfilter an. Da das \gls{PY} Signal durch ein Informationssignal mit deutlich höherer Bandbreite moduliert ist und durch den Chipping Code ein pseudo-Zu\-falls\-ver\-hal\-ten aufweist ergeben sich nach der Tiefpassfilterung wieder die Konstellationspunkte $C_{1,2}$.

\FG{\input{figures/GPSConstellation.tex}}{Konstellationsdiagramm des L1 GPS Signals (blau, $P_{0,1}+C_{0,1}$). Das GPS Signals ergibt sich durch Addition des modulierten \gls{CA} Trägers (rot, $C_{0,1}$) mit dem modulierten, um \SI{3}{\dB} gedämpften, \gls{PY} Trägers.}{GPSConstellation}

\paragraph{Polarisation} Das Signal wird mit einer rechtszirkular polarisierten Antenne ausgestrahlt. Dies hilft Multipath ausbreitung zu unterdrücken: Eine Reflektion dreht die Polarisation zu einer linkspolariserten Welle. Durch Verwendung einer rechtszirkular polarisierten Empfangsantenne wird das reflektierte Signal beim Empfang unterdrückt.

\subsection{Multiplex Verfahren \gls{CDMA}}
Wie im vorherigen Abschnitt beschrieben senden alle GPS Satelliten auf derselben Frequenz. Zum Multiplexen der vielen Signale kommt bei GPS \gls{CDMA} zum Einsatz. Dabei wird das eigentliche Informationssignal vor der Modulation auf dem Träger mit einem Codewort multipliziert. Jeder aktive Satellit hat ein individuelles Codewort zugewiesen. Die unterschiedlichen Codeworte werden durch die sogenannte \gls{PRN} identifiziert. 

Da die Coderate deutlich größer ist als die Informationrate erhöht sich durch die Multiplikation mit dem Codewort die Bandbreite des Signals stark. Daher zählt \gls{CDMA} zu den \emph{Spread Spectrum} Verfahren (\enquote{\emph{aufspreizen}}).

Die Codeworte haben die Eigenschaft orthogonal zueinander zu sein, haben also eine geringe Kreuzkorrelation (\FR{GoldcodeXcorr.png}). Außerdem weisen sie für Verschiebungen $k\neq0$ eine sehr geringe Autokorrelation auf (\FR{GoldcodeAKF.png}). Letzteres ist ein weiteres Mittel um Multipath Empfangswege zu unterdrücken: Die reflektierten Signale kommen im Vergleich zum direkten Ausbreitungsweg verzögert an. Bei der Demodulation wird die Frequenzspreizung wieder rückgängig gemacht, was nur bei exakter Übereinstimmung der Codephase $k$ gelingt. Folglich werden die reflektierten Signale stark unterdrückt.

\FGimg{GoldcodeAKF.png}{Zirkuläre Autokorrelationsfunktion ($\mathcal{F}^{-1}(X\cdot X^*)_k$) eines Goldcode Wortes. Die Autokorrelation ist lediglich bei perfekter Überlagerung (Verschiebung $k=0$) groß, ansonsten sehr klein. (vgl mit \FR{GoldcodeXcorr.png})}{.9\textwidth}

\FGimg{GoldcodeXcorr.png}{Zirkuläre Kreuzkorrelation ($\mathcal{F}^{-1}(X\cdot Y^*)_k$) zweier unterschiedlicher Goldcode Worte. Die Kreuzkorrelation ist sehr gering (vgl mit \FR{GoldcodeAKF.png})}{.9\textwidth}

Da die Bits des Codeworts keine Information enthalten werden sie zur besseren Unterscheidung als \glspl{Chip} bezeichnet. Die wichtigen Parameter für CDMA sind die \emph{Coderate} und der verwendete Code. Das zivil nutzbare GPS Signal hat eine Coderate von \SI{1.023}{MChip/s} und verwendet \emph{Gold Codefolgen} (benannt nach Robert Gold). Die Gold Codefolgen werden durch die punktweise Modulo-2 Addition zweier \emph{Maximum Length Sequences} \gls{LFSR} erzeugt. Je nach \gls{PRN} werden bei der Addition andere Abgriffe (\emph{Taps}) an dem \gls{LFSR} verwendet. Die erzeugenden Polynome der beiden ML Sequenzen sind $G_1: 1 + x^3 + x^10$ und $G_2: 1 + x^2 + x^3 +x^6 + x^8 + x^9 + x^{10}$. \FR{LFSRGoldcode.png} stellt die Generierung der Gold Codes grafisch dar. Eine Liste mit der Zuordnung der verwendeten Abgriffe ist \cite{specification2010gps} zu entnehmen.

\FGimg{LFSRGoldcode.png}{Erzeugung der Goldcode Folgen durch punktweiser Modulo-2 Addition (\emph{XOR}) zweier Maximum Length Sequences die jeweils durch ein \gls{LFSR} erzeugt werden. Die Abgriffe die bei der Addition verwendet werden sind Abhängig von der \gls{PRN}}{.9\textwidth}


\label{Grundlagen_Acquisition}

\subsection{Prozessablauf der Demodulation}
In diesem Abschnitt wird der prinzipielle Ablauf der Demodulation des GPS Signals beschrieben. Es wird hier davon ausgegangen, dass das von der Antenne kommende Signal bereits auf eine Zwischenfrequenz $f_{ZF}$ heruntergemischt wurde und digitalisert wurde. Damit gestaltet sich die Demodulation eigentlich einfach: Es werden einfach die Schritte der Modulation erneut durchgeführt: Multiplikation mit dem Träger und Multiplikation mit dem CA Code (TODO Grafik). Am Ausgang des Demodulators liegt dann das ursprüngliche Informationssignal an. Im Detail ist der Prozess jedoch komplexer und kann in drei Schritte aufgeteilt werden, die im Folgenden beschrieben werden.

\subsubsection{Acquisition}
Die zuvor beschriebene Demodulation hängt von mehreren, zunächst unbekannten, Variablen ab. Diese Unbekannten zu bestimmen ist Aufgabe der Acquisition.
Wie in Abschnitt (TODO Link) beschrieben wird zum Multiplexen der Signale der über 30 Satelliten das Signal CDMA kodiert, wobei jeder aktive Satellit einen anderen Code verwendet. Deshalb und weil der Signalpegel beim Empfang unter dem thermischen Rauschen liegt, ist aus den Rohdaten erst einmal nicht ersichtlich welche Satelliten überhaupt in Sicht sind. Die erste zu bestimmende Unbekannte ist also welche GPS Satelliten überhaupt in Sicht sind. Jeder Satellit ist dabei durch eine Nummer, die PRN identifiziert.

Die zweite Unbekannte ist die Codephase (TODO Link Glossar): Wie beschrieben (TODO Link) haben die verwendeten Codes eine geringe Autokorrelation für Verschiebungen („Codephase“ TODO Format) ungleich Null. Wenn also bei der Demodulation die Code Replika eine zu große Verschiebung aufweist wird am Ausgang des Demodulators lediglich Rauschen zu sehen sein.
Die dritte Unbekannte ist die exakte Trägerfrequenz (bzw., da das Signal im HF Frontend herabgemischt wird, die exakte Zwischenfrequenz). Die Trägerfrequenz ist zwar spezifiziert, und die ZF aus dem Systemdesign bekannt. Aber mehrere Faktoren sorgen in der Realität für Abweichungen: Zum einen sorgt der in Kapitel (TODO Link) beschriebene Dopplereffekt für eine zeitabhängige Frequenzverschiebung. Weitere Faktoren sind Jitter und Drift des Quarzoszillators auf der Empfängerseite, die ebenfalls Zeit- und Temperaturabhängig sind. Da der Acquisition Algorithmus nicht zwischen den Ursachen der Trägerfrequenzabweichung unterscheidet und die Abweichung größtenteils durch die Doppler Verschiebung bestimmt wird, wird im Weiteren nur von der Bestimmung des Dopplershifts gesprochen. 

Es ist zu betonen, dass alle drei genannten Unbekannten gleichzeitig gefunden werden müssen. Denn wenn zum Beispiel die korrekte Trägerfrequenz bekannt ist, aber die Codephase oder PRN falsch ist, wird der Demodulator lediglich wiederum ein Rauschsignal liefern. Es wird also ein Korrelationsmaximum im dreidimensionalen Raum aus PRN, Frequenz, und Codephase gesucht.

\paragraph{Suchalgorithmus}
Es gibt verschiedene Möglichkeiten zur Suche. Die einfachste, aber auch langsamste Methode ist die serielle Suche. Dabei wird das Eingangssignal (TODO variable) punktweise mit einer Kopie des Codes und des Trägers multiplizier, wobei nacheinander verschiedene Kombinationen von PRN, Dopplershift und Codephase ausprobiert werden. Aufgrund der großen Anzahl möglicher Kombinationen und Rechenoperationen ist dies jedoch äußerst zeitaufwändig. (TODO Beispielrechnung Tabelle?)
Effizienter sind Methoden die sich die Fourier Transformation zunutze machen, um die aufwändige Berechnung der Kreuzkorrelation zu vereinfachen. Diese Suche muss zwar immer noch für jede PRN ausgeführt werden. Aber der Rechenaufwand bei den weiteren Schritten ist deutlich geringer. 
In dieser Arbeit wird eine zweischrittige Methode aus paralleler Codephasen Suche und paralleler Frequenzsuche verwendet. Im ersten Schritt wird der Dopplershift lediglich grob bestimmt (TODO +-500 Hz), dafür die Codephase aber mit hoher Genauigkeit bestimmt. Im zweiten Schritt ist dann die Codephase bekannt, und es kann eine parallele Suche im Frequenzbereich durchgeführt werden um den Dopplershift genauer zu bestimmen.

Bei der parallelen Codephasen Suche werden zuerst für den zu durchsuchenden Frequenzbereich Kopien des Trägers (jeweils I und Q Anteil) in einem groben Raster (TODO z.B. 500 Hz) generiert. Außerdem wird für jede PRN die Fouriertransformierte des Codes berechnet (Da sich diese nicht ändern können sie auch in einer Look Up Table abgelegt werden). Nacheinander wird dann für jede Trägerfrequenz das Eingangssignal mit dem Träger multipliziert. Im Unterschied zur seriellen Suche wird dann das Signal (TODO Variable) Fourier Transformiert. Die TODO FT wird dann mit jeder Code TODO FT punktweise multipliziert und anschließend zurücktransformiert. Im Ergebnisvektor wird dann eine Suche nach dem Maximum durchgeführt und TODO max() und argmax(f(codephase)) gespeichert. Dieser Vorgang wird für alle Dopplershifts wiederholt, und anschließend das globale TODO max() und argmax(f(codephase,dopplershift) gesucht. Das gefundene argmax() ist dann die Codephase und Dopplershift für diese PRN.

Dieser Vorgang wird für alle PRN wiederholt. Das Finden des Maximums ist allerdings noch nicht hinreichend um sagen zu können, dass der Satellit in Sicht ist, denn es existiert immer ein Maximum. Deshalb wird zusätzlich noch das Peak to Average Ratio untersucht. Wenn dies über einem im Design festgelegten Wert liegt, wird die PRN zu der Liste der PRN in Sicht hinzugefügt.

Für jede der PRN in Sicht wird dann der Dopplershift mit einer parallelen Frequenzbereich Suche genauer bestimmt. Dazu wird das Eingangssignal mit dem Code (dessen Codephase nun bekannt ist) punktweise multipliziert, und somit entspreizt. Das Ergebnis wird anschließend Fourier transformiert und das Maximum im Frequenzbereich gesucht. Das TODO argmax() ist der gesuchte Dopplershift.

\paragraph{Entwurf der Parameter für die Acquisition}
Die wichtigen Parameter für die Acquisiton sind die Grenzen des zu durchsuchenden Raums.
Die derzeit aktiven Satelliten haben die Codes mit den PRN 1-32 zugewiesen. Der Bereich der möglichen Codephasen ergibt sich aus der Dauer einer Codeperiode (Codelänge/Chippingrate TODO), und der Sampling Frequenz des Frontend ICs (TODO Formel): N=fs/(fchip/Lcode)=16.369MHz/(1.023Mchip/s/1023) = 16369 MHz *TODO Fußnote: Die Samplingfrequenz im Flugmodell beträgt 16.368 MHz).

Da der Doppler Shift die Hauptursache ist entspricht die Abweichung dem maximal erwarteten Doppler Shift. Wie in Kapitel (todo link) besprochen, ist der erwartete Doppler Shift (TODO +-)45 kHz.

Die Schwelle ab der ein Signal nach dem ersten Schritt der Acquisition als „vorhanden“ bewertet wird wird auf ein Peak-to-Average Ratio von 2,5 festgelegt. Dieser Wert wurde durch Simulation für Signale gefunden, die ein gerade noch ausreichendes SNR haben.

\subsubsection{Tracking}
Die Acquisition ist wie beschrieben ein relativ aufwändiger Prozess, und wird lediglich durchgeführt, wenn neue GPS Satelliten gesucht werden, beispielsweise nach dem Systemstart, oder wenn das Signal verloren wird. Sobald die Parameter (PRN, Codephase, Dopplershift) durch die Acquisition bekannt sind, werden diese an den eigentlichen Demodulator, den Trackingloop, weitergegeben. Der Begriff Trackingloop kommt daher, dass die Codephase und Dopplershift die bei der Acquisition bestimmt werden jeweils nur Momentaufnahmen sind. Dopplershift und Codephase ändern sich ständig und auch Ungenauigkeiten der Takterzeugung beim Empfänger müssen ausgeglichen werden. Der Trackingloop hat die Aufgabe die in der Acquisitonphase bestimmten Werte mittels eines Regelkreises („control loop“) nachzuführen („to track“). 
Die Funktion des Trackingloops wird im Folgenden nur grob diskutiert. Es werden stattdessen die wichtigen Entwurfsparameter und Entscheidungen beschrieben. 
Der Trackingloop hat wie erwähnt die Aufgabe die Frequenz des LO und die Codephase anzupassen. Zuerst soll die Regelschleife für den Träger, der Carrier Trackingloop, beschrieben werden.

Bild (TODO Ref) zeigt ein Blockschaltbild des Trackingloops. Im folgenden werden kurz die Funktionen der einzelnen Blöcke erklärt. Eine detaillierte Beschreibung des Trackingloops ist in (TODO Referenz GPS Buch) zu finden.

\paragraph{Carrier NCO} Der Carrier \gls{NCO} 

\paragraph{Carrier Mischer} Der Carrier Mischer mischt das Eingangssignal (TODO passend Zeichnung) $x$ mit dem LO Signal. Bei korrekter Einstellung des LO wird das Eingangssignal von der ersten ZF $f_{ZF}$ herunter auf \SI{0}{\Hz} gemischt.

\paragraph{Tiefpass Filter} Der Tiefpass Filter entfernt di

\paragraph{Carrier Diskriminator}

\paragraph{Carrier Loop Filter}


\paragraph{Code Mischer}
\paragraph{Integrate \& Dump}
\paragraph{Code Diskriminator}
\paragraph{Code Loop Filter}
\paragraph{Code NCO}


\paragraph{Carrier Tracking}
Zum Synchronisieren der LO Frequenz mit der Trägerfrequenz des Empfangssignals wird im Allgemeinen ein Phase Locked Loop (PLL) verwendet, der versucht die Phasendifferenz zwischen Eingangssignal und LO Signal auf null zu halten. Im Falle des GPS Signals ist jedoch zu beachten, dass der Träger BPSK moduliert ist, also Phasendifferenzen von \SI{0}{\degree} oder \SI{180}{\degree} gewollt ist. Eine Variante von PLL die diesen \SI{180}{\degree} Phasenfehler ignoriert ist der Costas Loop (TODO Grafik).
Dazu erzeugt der LO zwei Kopien des Trägers, die zueinander \SI{90}{\degree} verschoben sind: $c_I=\cos(\omega_{LO} t)$ $c_Q=\sin(\omega_{LO} t)$ (TODO Bezeichnung an Zeichnung anpassen). Das Signal wird im jeweiligen Arm mit dem $I$ bzw $Q$ Träger gemischt, und Tiefpassgefiltert. (TODO Formel Multiplikation der Signale). Beim Costas Loop wertet der Loopdiskriminator die Energie im I und Q Arm aus, wobei das Ziel des Regelkreises ist gesamte Energie im I Arm zu halten. Als Loopdiskriminator bietet sich $\arctan\left(\frac{Q}{I}\right)$ an. Die Charakteristik des TODO arctan Diskriminators ist in Grafik TODO dargestellt. Wie man sieht hat die $\arctan()$ Funktion Nullstellen für \SI{0}{\degree} und \SI{180}{\degree}, woraus sich die Immunität gegen die BPSK Modulation ergibt.

\paragraph{Code Tracking}
Der Code Tracking Loop ist dafür zuständig die Phase des Codegenerators so anzupassen, dass sie mit der Phase des Codes im Empfangssignal übereinstimmt. In dieser Arbeit wurde dafür ein \emph{Early-Late-Gate} verwendet. Bei diesem wird das Signal parallel mit drei Kopien des Codes multipliziert, wobei die drei Codekopien zeitlich zueinander verzögert sind, üblicherweise um die Dauer $\frac{1}{2}$ Chips. Die drei Kopien werden mit \emph{Early} (\enquote{verfrüht}), \emph{Prompt} (\enquote{pünktlich}) und \emph{Late} (\enquote{verspätet}) bezeichnet. Bei korrekter Codephase wird die Energie im \emph{Prompt} Zweig am höchsten sein, und die Energie in den \emph{Early} und \emph{Late} Zweigen gleich groß. Falls die Phase des Codes dagegen zu klein eingestellt ist, wird die Energie im \emph{Late} Zweig steigen, und der Code Loop Diskriminator regelt entsprechend gegen.

\paragraph{Loop Filter}
Der Ausgang der Carrier- bzw. Code Loop Diskriminatoren ist der Wert des Phasenfehlers. Zur Ansteuerung des (TODO Glossar) NCO wird .